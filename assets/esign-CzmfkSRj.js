
/**
 * 由 Kpu-mobile 提供技术支持
 * Powered by Kpu-mobile
 * https://kpu-mobile.kpui.top/
 */
    
import{_ as k}from"./index-Czg9Ols8.js";import{_ as B}from"./index.vue_vue_type_script_setup_true_lang-CIWwt91K.js";import{v as M,k as R,o as T,d as S,r as w,U as E,m as _,c as b,w as u,a as f,b as v,p as I,u as d,_ as X,e as p,f as Y,i as N,S as P}from"./index-CEhcQr1Q.js";import{s as U}from"./function-call-D3B_gvgw.js";const W={props:{width:{type:Number,default:800},height:{type:Number,default:300},lineWidth:{type:Number,default:4},lineColor:{type:String,default:"#000000"},bgColor:{type:String,default:""},isCrop:{type:Boolean,default:!1},isClearBgColor:{type:Boolean,default:!0},format:{type:String,default:"image/png"},quality:{type:Number,default:1}},data(){return{hasDrew:!1,resultImg:"",points:[],canvasTxt:null,startX:0,startY:0,isDrawing:!1,sratio:1}},computed:{ratio(){return this.height/this.width},stageInfo(){return this.$refs.canvas.getBoundingClientRect()},myBg(){return this.bgColor?this.bgColor:"rgba(255, 255, 255, 0)"}},watch:{myBg:function(t){this.$refs.canvas.style.background=t}},beforeMount(){window.addEventListener("resize",this.$_resizeHandler)},beforeDestroy(){window.removeEventListener("resize",this.$_resizeHandler)},mounted(){const t=this.$refs.canvas;t.height=this.height,t.width=this.width,t.style.background=this.myBg,this.$_resizeHandler(),document.onmouseup=()=>{this.isDrawing=!1}},methods:{$_resizeHandler(){const t=this.$refs.canvas;t.style.width=this.width+"px";const e=parseFloat(window.getComputedStyle(t).width);t.style.height=this.ratio*e+"px",this.canvasTxt=t.getContext("2d"),this.canvasTxt.scale(1*this.sratio,1*this.sratio),this.sratio=e/this.width,this.canvasTxt.scale(1/this.sratio,1/this.sratio)},mouseDown(t){t=t||event,t.preventDefault(),this.isDrawing=!0,this.hasDrew=!0;let e={x:t.offsetX,y:t.offsetY};this.drawStart(e)},mouseMove(t){if(t=t||event,t.preventDefault(),this.isDrawing){let e={x:t.offsetX,y:t.offsetY};this.drawMove(e)}},mouseUp(t){t=t||event,t.preventDefault();let e={x:t.offsetX,y:t.offsetY};this.drawEnd(e),this.isDrawing=!1},touchStart(t){if(t=t||event,t.preventDefault(),this.hasDrew=!0,t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawStart(e)}},touchMove(t){if(t=t||event,t.preventDefault(),t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawMove(e)}},touchEnd(t){if(t=t||event,t.preventDefault(),t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawEnd(e)}},drawStart(t){this.startX=t.x,this.startY=t.y,this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.lineWidth=this.lineWidth*this.sratio,this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.points.push(t)},drawMove(t){this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.strokeStyle=this.lineColor,this.canvasTxt.lineWidth=this.lineWidth*this.sratio,this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.startY=t.y,this.startX=t.x,this.points.push(t)},drawEnd(t){this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.points.push(t),this.points.push({x:-1,y:-1})},generate(t){let e=t&&t.format?t.format:this.format,i=t&&t.quality?t.quality:this.quality;return new Promise((h,a)=>{if(!this.hasDrew){a("Warning: Not Signned!");return}var n=this.canvasTxt.getImageData(0,0,this.$refs.canvas.width,this.$refs.canvas.height);this.canvasTxt.globalCompositeOperation="destination-over",this.canvasTxt.fillStyle=this.myBg,this.canvasTxt.fillRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.resultImg=this.$refs.canvas.toDataURL(e,i);var c=this.resultImg;if(this.canvasTxt.clearRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.canvasTxt.putImageData(n,0,0),this.canvasTxt.globalCompositeOperation="source-over",this.isCrop){const s=this.getCropArea(n.data);var r=document.createElement("canvas");const l=r.getContext("2d");r.width=s[2]-s[0],r.height=s[3]-s[1];const g=this.canvasTxt.getImageData(...s);l.globalCompositeOperation="destination-over",l.putImageData(g,0,0),l.fillStyle=this.myBg,l.fillRect(0,0,r.width,r.height),c=r.toDataURL(e,i),r=null}h(c)})},reset(){this.canvasTxt.clearRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.isClearBgColor&&(this.$emit("update:bgColor",""),this.$refs.canvas.style.background="rgba(255, 255, 255, 0)"),this.points=[],this.hasDrew=!1,this.resultImg=""},getCropArea(t){for(var e=this.$refs.canvas.width,i=0,o=this.$refs.canvas.height,h=0,a=0;a<this.$refs.canvas.width;a++)for(var n=0;n<this.$refs.canvas.height;n++){var c=(a+this.$refs.canvas.width*n)*4;(t[c]>0||t[c+1]>0||t[c+2]||t[c+3]>0)&&(h=Math.max(n,h),i=Math.max(a,i),o=Math.min(n,o),e=Math.min(a,e))}return e++,i++,o++,h++,[e,o,i,h]}}};function z(t,e,i,o,h,a){return T(),R("canvas",{ref:"canvas",onMousedown:e[0]||(e[0]=(...n)=>a.mouseDown&&a.mouseDown(...n)),onMousemove:e[1]||(e[1]=(...n)=>a.mouseMove&&a.mouseMove(...n)),onMouseup:e[2]||(e[2]=(...n)=>a.mouseUp&&a.mouseUp(...n)),onTouchstart:e[3]||(e[3]=(...n)=>a.touchStart&&a.touchStart(...n)),onTouchmove:e[4]||(e[4]=(...n)=>a.touchMove&&a.touchMove(...n)),onTouchend:e[5]||(e[5]=(...n)=>a.touchEnd&&a.touchEnd(...n))},null,544)}const y=M(W,[["render",z],["__scopeId","data-v-1fcc7cb1"]]);y.install=function(t){this.installed||(this.installed=!0,t.component("vueEsign",y))};const L={class:"whitespace-break-spaces p-4 space-y-2"},q={class:"space-x-2"},H={class:"flex flex-col gap-4 p-4"},K={class:"mt-2 space-x-2"},O=["src"],G=S({__name:"esign",setup(t){const e=w(!1),i=E("esignRef"),o=w({lineWidth:6,lineColor:"#000000",bgColor:"#f0f0f0",isCrop:!1}),h=w("");function a(){i.value.reset(),P(()=>{o.value.bgColor="#f0f0f0"})}function n(){i.value.generate().then(r=>{h.value=r}).catch(()=>{U({message:"画板为空，无法生成图片"})})}function c(){i.value.generate().then(r=>{const s=new Image;s.setAttribute("crossOrigin","anonymous"),s.onload=()=>{const l=document.createElement("a"),g=new MouseEvent("click");l.download=Date.parse(new Date().toString()).toString(),l.href=s.src,l.dispatchEvent(g)},s.src=r})}return(r,s)=>{const l=Y,g=_("van-tag"),D=_("van-action-sheet"),x=X,C=B,$=k;return T(),b($,{navbar:"","navbar-start-side":"back"},{"navbar-end":u(()=>[f("div",{class:"h-full flex-center px-1",onClick:s[0]||(s[0]=m=>e.value=!0)},[v(l,{name:"i-mdi:information",class:"text-4"})]),v(D,{show:d(e),"onUpdate:show":s[1]||(s[1]=m=>N(e)?e.value=m:null),teleport:"body"},{default:u(()=>[f("div",L,[s[4]||(s[4]=f("div",null," 「插件」栏目下均为第三方插件的演示页面，框架默认并不包含这些插件。如需使用，请先安装对应插件。 ",-1)),s[5]||(s[5]=f("div",null,"安装命令：",-1)),f("div",q,[v(g,{type:"primary",plain:""},{default:u(()=>s[3]||(s[3]=[p(" pnpm add vue-esign ")])),_:1})])])]),_:1},8,["show"])]),default:u(()=>[f("div",H,[v(C,{class:"m-0"},{default:u(()=>[v(d(y),{ref_key:"esignRef",ref:i,"bg-color":d(o).bgColor,"onUpdate:bgColor":s[2]||(s[2]=m=>d(o).bgColor=m),width:800,height:400,"is-crop":d(o).isCrop,"line-width":d(o).lineWidth,"line-color":d(o).lineColor},null,8,["bg-color","is-crop","line-width","line-color"]),f("div",K,[v(x,{onClick:a},{default:u(()=>s[6]||(s[6]=[p(" 清空画板 ")])),_:1}),v(x,{onClick:n},{default:u(()=>s[7]||(s[7]=[p(" 生成图片 ")])),_:1}),v(x,{onClick:c},{default:u(()=>s[8]||(s[8]=[p(" 下载图片 ")])),_:1})])]),_:1}),d(h)?(T(),b(C,{key:0,class:"m-0"},{default:u(()=>[f("img",{src:d(h),class:"aspect-ratio-[800/400] w-full"},null,8,O)]),_:1})):I("",!0)])]),_:1})}}});export{G as default};
